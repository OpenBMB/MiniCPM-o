# ============================================
# MiniCPM-o 4.5 Docker Compose 部署配置
# ============================================
# 使用方式:
#   docker compose -f deploy/docker-compose.yml up -d
#
# 前提条件:
#   1. 服务器已安装 NVIDIA Container Toolkit
#   2. 模型权重已放置在 ${MODEL_PATH} 目录下
# ============================================

services:
  # ---- 后端推理服务（GPU）----
  model-backend:
    image: minicpmo-backend:latest
    container_name: minicpmo-backend
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      # 挂载模型权重目录（宿主机路径 → 容器路径）
      - ${MODEL_PATH:-/jtkl-hdd1-storage-1/60b9066159fc4bb783278ce0d226ceb2/data/jinlujia/codes/MiniCPM-o/models/MiniCPM-o-4_5}:/models/MiniCPM-o-4_5:ro
    environment:
      - BACKEND_PORT=${BACKEND_PORT:-32550}
    ports:
      - "${BACKEND_PORT:-32550}:${BACKEND_PORT:-32550}"
    # 注意：BACKEND_PORT 为应用监听端口（默认 32550），
    # 与外部 SSH 临时隧道端口不同。
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${BACKEND_PORT:-32550}/api/v1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # 模型加载需要较长时间
    networks:
      - minicpmo-net

  # ---- 前端 Web 服务（Nginx）----
  web-frontend:
    image: minicpmo-frontend:latest
    container_name: minicpmo-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
      - "3443:3443"   # HTTPS（手机端访问）
    volumes:
      # 挂载 SSL 证书目录
      - ${CERTS_PATH:-/jtkl-hdd1-storage-1/60b9066159fc4bb783278ce0d226ceb2/data/jinlujia/codes/MiniCPM-o/runtime/certs}:/etc/nginx/certs:ro
    environment:
      - BACKEND_PORT=${BACKEND_PORT:-32550}
    depends_on:
      model-backend:
        condition: service_started
    networks:
      - minicpmo-net

networks:
  minicpmo-net:
    driver: bridge
